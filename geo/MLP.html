<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLP Flood Predictor (Elevation, Distance, Water Level, Discharge, Rainfall)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-3">MLP Flood Predictor — HTML + JS (TensorFlow.js)</h1>
    <p class="text-muted">Inputs: elevation, distance from river, water level, water discharge, rainfall. This single-file demo builds, trains, and runs a small MLP in the browser.</p>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Manual Input / Predict</h5>
          <div class="mb-2">
            <label class="form-label">Elevation (m)</label>
            <input id="in_elev" class="form-control" type="number" step="any" value="10">
          </div>
          <div class="mb-2">
            <label class="form-label">Distance from river (m)</label>
            <input id="in_dist" class="form-control" type="number" step="any" value="50">
          </div>
          <div class="mb-2">
            <label class="form-label">Water level (m)</label>
            <input id="in_level" class="form-control" type="number" step="any" value="2">
          </div>
          <div class="mb-2">
            <label class="form-label">Water discharge (m³/s)</label>
            <input id="in_discharge" class="form-control" type="number" step="any" value="20">
          </div>
          <div class="mb-3">
            <label class="form-label">Rainfall (mm)</label>
            <input id="in_rain" class="form-control" type="number" step="any" value="10">
          </div>

          <div class="d-grid gap-2 d-md-flex">
            <button id="btnPredict" class="btn btn-primary">Predict</button>
            <button id="btnRandomPredict" class="btn btn-outline-secondary">Random predict</button>
          </div>

          <div class="mt-3">
            <h6>Prediction</h6>
            <div id="predictionBox" class="h4">—</div>
            <small class="text-muted">Output is a probability (0–1) where higher = higher flood risk.</small>
          </div>
        </div>

        <div class="card p-3 mt-3">
          <h5>Training / Dataset</h5>
          <p class="small">You can generate synthetic samples, upload a CSV, or train on existing data. CSV must have 6 columns (elevation,distance,level,discharge,rainfall,label). Label should be 0/1.</p>

          <div class="mb-2">
            <input id="fileInput" type="file" accept=".csv" class="form-control form-control-sm">
          </div>

          <div class="d-grid gap-2 d-md-flex">
            <button id="btnGenerate" class="btn btn-outline-success">Generate sample data (200)</button>
            <button id="btnTrain" class="btn btn-success">Train model</button>
            <button id="btnClear" class="btn btn-danger">Clear dataset</button>
          </div>

          <div class="mt-2">
            <label>Epochs</label>
            <input id="epochs" type="number" class="form-control form-control-sm" value="50">
            <label class="mt-2">Batch size</label>
            <input id="batchSize" type="number" class="form-control form-control-sm" value="32">
          </div>

          <div class="mt-3">
            <h6>Training status</h6>
            <div id="trainStatus">Idle</div>
            <canvas id="lossChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h5>Model Architecture & Controls</h5>
          <p class="small">This demo uses a simple Sequential MLP: Dense(64)->Dense(32)->Dense(1, sigmoid). You can customize inside the script.</p>

          <pre id="modelSummary" style="white-space:pre-wrap; background:#f8f9fa; padding:10px; border-radius:6px;">Model not created yet.</pre>

          <div class="mt-2">
            <button id="btnCreate" class="btn btn-outline-primary">Create Model</button>
            <button id="btnResetModel" class="btn btn-outline-danger">Reset Model</button>
          </div>

          <hr>

          <h6>Dataset preview (first 8 rows)</h6>
          <pre id="dataPreview" style="white-space:pre-wrap; background:#fff; padding:10px; border-radius:6px; height:220px; overflow:auto; border:1px solid #e9ecef">No data</pre>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Simple in-browser MLP demo using TensorFlow.js
    let model = null;
    let dataset = []; // array of {x: [5 inputs], y: 0/1}
    let norm = {mean: null, std: null};

    const inputNames = ['elevation','distance','water_level','discharge','rainfall'];

    // Utilities
    function show(msg){ document.getElementById('trainStatus').innerText = msg; }
    function prettyDataPreview(){
      const preview = dataset.slice(0,8).map(d => d.x.concat([d.y]).map(v=>Number(v).toFixed(3)).join(', '));
      document.getElementById('dataPreview').innerText = preview.length? preview.join('\n') : 'No data';
    }

    // Create model function
    function createModel(){
      model = tf.sequential();
      model.add(tf.layers.dense({inputShape:[5], units:64, activation:'relu'}));
      model.add(tf.layers.dense({units:32, activation:'relu'}));
      model.add(tf.layers.dense({units:1, activation:'sigmoid'}));
      model.compile({optimizer: tf.train.adam(0.001), loss:'binaryCrossentropy', metrics:['accuracy']});
      document.getElementById('modelSummary').innerText = '';
      model.summary(undefined, undefined, s => { document.getElementById('modelSummary').innerText += s + '\n'; });
    }

    // Reset
    function resetModel(){
      if(model){ model.dispose(); model = null; }
      document.getElementById('modelSummary').innerText = 'Model reset.';
    }

    // Normalize dataset
    function computeNorm(){
      if(!dataset.length) return;
      const xs = tf.tensor2d(dataset.map(d=>d.x));
      const mean = xs.mean(0);
      const std = xs.sub(mean).square().mean(0).sqrt().add(1e-6);
      norm.mean = mean.arraySync();
      norm.std = std.arraySync();
      xs.dispose(); mean.dispose(); std.dispose();
    }

    function normalizeArray(arr){
      return arr.map((v,i)=> (v - (norm.mean?norm.mean[i]:0)) / (norm.std?norm.std[i]:1));
    }

    // Convert dataset to tensors
    function getTensors(){
      computeNorm();
      const xs = tf.tensor2d(dataset.map(d=>normalizeArray(d.x)));
      const ys = tf.tensor2d(dataset.map(d=>[d.y]));
      return {xs, ys};
    }

    // Train
    async function trainModel(){
      if(!model) { alert('Create the model first'); return; }
      if(!dataset.length) { alert('Add or load dataset first'); return; }
      const epochs = Number(document.getElementById('epochs').value) || 50;
      const batchSize = Number(document.getElementById('batchSize').value) || 32;
      const {xs, ys} = getTensors();
      show('Training...');

      lossData = [];
      lossChart.data.labels = [];
      lossChart.data.datasets[0].data = [];
      lossChart.update();

      await model.fit(xs, ys, {
        epochs,
        batchSize,
        shuffle:true,
        callbacks: {
          onEpochEnd: (epoch, logs) => {
            lossData.push(logs.loss);
            lossChart.data.labels.push(epoch+1);
            lossChart.data.datasets[0].data.push(logs.loss);
            lossChart.update();
            show(`Epoch ${epoch+1}/${epochs} — loss: ${logs.loss.toFixed(4)}`);
          }
        }
      });
      xs.dispose(); ys.dispose();
      show('Training finished');
    }

    // Predict
    async function predictSample(sample){
      if(!model) { alert('Create and train the model first'); return; }
      if(!norm.mean) computeNorm();
      const x = normalizeArray(sample);
      const t = tf.tensor2d([x]);
      const res = model.predict(t);
      const val = (await res.array())[0][0];
      t.dispose(); res.dispose();
      return val;
    }

    // Simple synthetic generator for demo: creates data where low elevation + high rainfall + high water level => label 1
    function generateSynthetic(n=200){
      dataset = [];
      for(let i=0;i<n;i++){
        const elev = Math.random()*50 - 10; // -10 to 40
        const dist = Math.random()*500; // 0 to 500
        const level = Math.random()*5 + (Math.random()<0.2?2:0); // 0-7
        const discharge = Math.random()*200; // 0-200
        const rain = Math.random()*100; // 0-100
        // heuristic score
        const score = ( (rain/100)*0.5 + (level/7)*0.3 + (1 - Math.min(Math.max((elev+10)/60,0),1))*0.2 ) * (1 - Math.min(dist/500,1));
        const prob = Math.min(Math.max(score,0),1);
        const label = Math.random() < prob ? 1 : 0;
        dataset.push({x:[elev, dist, level, discharge, rain], y: label});
      }
      prettyDataPreview();
    }

    // CSV loader
    function loadCSV(file){
      Papa.parse(file, {
        header: false,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results){
          const rows = results.data;
          for(const r of rows){
            if(r.length < 6) continue;
            const x = [Number(r[0]), Number(r[1]), Number(r[2]), Number(r[3]), Number(r[4])];
            const y = Number(r[5]) ? 1 : 0;
            dataset.push({x,y});
          }
          computeNorm();
          prettyDataPreview();
          show('CSV loaded: '+rows.length+' rows (used '+dataset.length+' total)');
        }
      });
    }

    // UI wiring
    document.getElementById('btnCreate').addEventListener('click', ()=>{ createModel(); show('Model created'); });
    document.getElementById('btnResetModel').addEventListener('click', resetModel);
    document.getElementById('btnGenerate').addEventListener('click', ()=>{ generateSynthetic(200); show('Synthetic data generated'); });
    document.getElementById('btnClear').addEventListener('click', ()=>{ dataset = []; norm = {mean:null,std:null}; prettyDataPreview(); show('Dataset cleared'); });
    document.getElementById('fileInput').addEventListener('change', (e)=>{ if(e.target.files.length) loadCSV(e.target.files[0]); });
    document.getElementById('btnTrain').addEventListener('click', ()=>{ trainModel(); });

    document.getElementById('btnPredict').addEventListener('click', async ()=>{
      const sample = [
        Number(document.getElementById('in_elev').value),
        Number(document.getElementById('in_dist').value),
        Number(document.getElementById('in_level').value),
        Number(document.getElementById('in_discharge').value),
        Number(document.getElementById('in_rain').value)
      ];
      const val = await predictSample(sample);
      document.getElementById('predictionBox').innerText = Number(val).toFixed(4) + ' (probability)';
    });

    document.getElementById('btnRandomPredict').addEventListener('click', async ()=>{
      const sample = [Math.random()*40-10, Math.random()*500, Math.random()*7, Math.random()*200, Math.random()*100];
      const val = await predictSample(sample);
      document.getElementById('predictionBox').innerText = sample.map(s=>s.toFixed(2)).join(', ') + ' → ' + Number(val).toFixed(4);
    });

    // Loss chart
    const ctx = document.getElementById('lossChart').getContext('2d');
    const lossChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{label:'Loss', data:[], fill:false, tension:0.2}]
      },
      options: {responsive:true, plugins:{legend:{display:false}}, scales:{x:{title:{display:true, text:'Epoch'}}, y:{title:{display:true, text:'Loss'}}}}
    });

    // Initialize
    prettyDataPreview();
    show('Idle — create model to start');
  </script>
</body>
</html>
