<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flooded Areas Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Mapbox GL CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

/* Navbar smaller and fixed height */
.navbar {
  padding: 0.3rem 1rem;
  min-height: 50px;
}

/* Make the main section fill the screen below navbar */
.main-container {
  height: calc(100vh - 50px);
  display: flex;
  flex-direction: row;
  overflow: hidden;
  padding: 5px;

}

/* Sidebar */
#sidebarPanel {
  flex: 0 20% 350px;
  max-width: 350px;
  min-width: 250px;
  height: 100%;
  overflow-y: auto;
  margin-right: 10px;
}

/* Map container */
#map {
  width: 100%;
  height: 100%;
  border-radius: 8px;
}

/* Card fills height */
.card, .card-body {
  height: 100%;
}

/* Make map take full remaining width */
.map-section {
  flex-grow: 1;
  height: 100%;
}

/* Mobile view: stack vertically */
@media (max-width: 991px) {
  .main-container {
    flex-direction: column;
  }
  #sidebarPanel {
    width: 100%;
    max-width: none;
    height: 40%;
  }
  .map-section {
    height: 60%;
  }
}

/* Sidebar items */
.list-item {
  cursor: pointer;
  padding: 8px 12px;
  border-bottom: 1px solid #eee;
}
.list-item:hover {
  background: #f0f0f0;
}
.list-item{
    background-color: white;
    border-radius: 15px;
}
.list-item:hover{
background-color: #0d6efd;
color: white;
}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Ilocos Norte Geospatial DSS</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">DASHBOARD</a></li>
        <li class="nav-item"><a class="nav-link " href="map6.html">MAP</a></li>
        <li class="nav-item"><a class="nav-link active" href="municipalities.html">MUNICIPALITIES</a></li>
        <li class="nav-item"><a class="nav-link" href="upload2.html">UPLOAD GEOJSON</a></li>
        <li class="nav-item"><a class="nav-link" href="#">LOGIN</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Main Container -->
<div class="main-container">
  <!-- Sidebar -->
  <div id="sidebarPanel" class="bg-light border-end">
    <div class="p-3">
      <h5 class="fw-bold">Municipal Boundaries</h5>
      <div class="status mb-2"><strong>Status:</strong> Loading data...</div>
      <div id="areaList"></div>
    </div>
  </div>

  <!-- Map Section -->
  <div class="map-section">
    <div id="map"></div>
  </div>
</div>

<!-- JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGhlc3RlcjA4IiwiYSI6ImNtaHFmc3BncjBwZGQybHM0NWN3ejNoNnIifQ.2kEE1OBDTgpnse5-F8QGeg';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/lhester08/cmhqgzq0r004601su4m8i8ov1',
  center: [120.587, 18.205],
  zoom: 9.5,
  pitch: 45
});

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBcayr5NOjbrAuLn7bkUovRWVyG4O9wMPk",
  authDomain: "flooded-95eeb.firebaseapp.com",
  projectId: "flooded-95eeb",
  storageBucket: "flooded-95eeb.firebasestorage.app",
  messagingSenderId: "142547476223",
  appId: "1:142547476223:web:70de7014c664e26d0636ca",
  measurementId: "G-MRFYTR1F5K"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function getColor(v) {
  if (v >= 80) return '#800026';
  if (v >= 60) return '#BD0026';
  if (v >= 40) return '#E31A1C';
  if (v >= 20) return '#FC4E2A';
  return 'green';
}

let currentLayerId = null;

// Calculate centroid
function getCentroid(coords) {
  let flat = coords.flat(3);
  let lons = flat.filter((_, i) => i % 2 === 0);
  let lats = flat.filter((_, i) => i % 2 === 1);
  let lon = lons.reduce((a, b) => a + b, 0) / lons.length;
  let lat = lats.reduce((a, b) => a + b, 0) / lats.length;
  return [lon, lat];
}

// Load Flooded_Areas from Firebase
db.ref('Flooded_Areas').on('value', snapshot => {
  const data = snapshot.val();
  const areaList = document.getElementById('areaList');
  areaList.innerHTML = '';
  document.querySelector('.status').innerHTML = "<strong>Status:</strong> Data loaded.";

  if (!data) return;

  Object.keys(data).forEach(key => {
    const f = data[key];
    if (!f.geojson) return;

    const listItem = document.createElement('div');
    listItem.className = 'list-item';
    listItem.innerText = f.name;

    listItem.addEventListener('click', () => {
      if (currentLayerId) {
        if (map.getLayer(currentLayerId)) map.removeLayer(currentLayerId);
        if (map.getSource(currentLayerId)) map.removeSource(currentLayerId);
      }

      currentLayerId = 'area-' + key;
      map.addSource(currentLayerId, { type: 'geojson', data: f.geojson });
      map.addLayer({
        id: currentLayerId,
        type: 'fill',
        source: currentLayerId,
        paint: {
          'fill-color': getColor(f.vulnerability || 0),
          'fill-opacity': 0.5
        }
      });

      let coords = f.geojson.type === "Feature" ? f.geojson.geometry.coordinates : f.geojson.features[0].geometry.coordinates;
      let center = getCentroid(coords);
      map.flyTo({ center: center, zoom: 11 });
    });

    areaList.appendChild(listItem);
  });
});
</script>
</body>
</html>
