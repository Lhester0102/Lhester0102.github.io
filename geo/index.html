<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Water Level Prediction System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background: #f4f6f8; }
.status { font-size: 0.9rem; color: #333; margin-top: 5px; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Ilocos Norte Geospatial DSS</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">DASHBOARD</a></li>
        <li class="nav-item"><a class="nav-link" href="map6.html">MAP</a></li>
        <li class="nav-item"><a class="nav-link" href="municipalities.html">MUNICIPALITIES</a></li>
        <li class="nav-item"><a class="nav-link" href="upload2.html">UPLOAD GEOJSON</a></li>
        <li class="nav-item"><a class="nav-link" href="#">LOGIN</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row g-3">
    <!-- Left Column -->
    <div class="col-lg-4">
      <!-- Upload CSV -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">Upload CSV Data</div>
        <div class="card-body">
          <input type="file" id="csvFileInput" accept=".csv" class="form-control mb-2">
          <button id="uploadCsvBtn" class="btn btn-primary w-100">Upload & Save</button>
          <div class="status" id="csvStatus">No file uploaded.</div>
        </div>
      </div>

      <!-- Predict Water Level -->
      <div class="card">
        <div class="card-header bg-success text-white">Predict Water Level</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Rainfall (mm)</label>
            <input type="number" step="0.01" id="rainfall" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Flow (mÂ³/s)</label>
            <input type="number" step="0.01" id="flow" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Water Level (m)</label>
            <input type="number" step="0.01" id="water_level" class="form-control">
          </div>
          <button id="predictBtn" class="btn btn-success w-100">Predict</button>
          <div class="status" id="predictStatus"></div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header bg-info text-white">Prediction Chart</div>
        <div class="card-body">
          <canvas id="predictionChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBcayr5NOjbrAuLn7bkUovRWVyG4O9wMPk",
  authDomain: "flooded-95eeb.firebaseapp.com",
  projectId: "flooded-95eeb",
  storageBucket: "flooded-95eeb.firebasestorage.app",
  messagingSenderId: "142547476223",
  appId: "1:142547476223:web:70de7014c664e26d0636ca",
  measurementId: "G-MRFYTR1F5K"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
// Chart setup
const ctx = document.getElementById('predictionChart').getContext('2d');
window.predChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Actual Water Level', data: [], borderColor: 'rgb(54,162,235)', backgroundColor: 'rgba(54,162,235,0.2)', fill:true, tension:0.3 },
            { label: '1-Hour Prediction', data: [], borderColor: 'rgb(255,206,86)', backgroundColor: 'rgba(255,206,86,0.2)', fill:true, tension:0.3 },
            { label: '3-Hour Prediction', data: [], borderColor: 'rgb(255,159,64)', backgroundColor: 'rgba(255,159,64,0.2)', fill:true, tension:0.3 },
            { label: '6-Hour Prediction', data: [], borderColor: 'rgb(255,99,132)', backgroundColor: 'rgba(255,99,132,0.2)', fill:true, tension:0.3 }
        ]
    },
    options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'bottom'}} }
});

// Upload CSV to 3 Firebase branches
document.getElementById('uploadCsvBtn').addEventListener('click', () => {
    const file = document.getElementById('csvFileInput').files[0];
    if(!file){ document.getElementById('csvStatus').innerText = "Select a CSV file first."; return; }

    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split('\n');
        lines.forEach(line => {
            const [rain, flow, level] = line.split(',').map(Number);
            if(!isNaN(rain) && !isNaN(flow) && !isNaN(level)){
                const timestamp = Date.now();
                db.ref('rainfall_data').push({ value: rain, timestamp });
                db.ref('water_flow_data').push({ value: flow, timestamp });
                db.ref('water_level_data').push({ value: level, timestamp });
            }
        });
        document.getElementById('csvStatus').innerText = "CSV uploaded successfully!";
        loadLastRecords();
    };
    reader.readAsText(file);
});

// Load last records from all 3 datasets
function loadLastRecords(n=20){
    Promise.all([
        db.ref('rainfall_data').orderByChild('timestamp').limitToLast(n).once('value'),
        db.ref('water_flow_data').orderByChild('timestamp').limitToLast(n).once('value'),
        db.ref('water_level_data').orderByChild('timestamp').limitToLast(n).once('value')
    ]).then(([rainSnap, flowSnap, levelSnap]) => {
        const rainData = Object.values(rainSnap.val() || {});
        const flowData = Object.values(flowSnap.val() || {});
        const levelData = Object.values(levelSnap.val() || {});
        const len = Math.min(rainData.length, flowData.length, levelData.length);

        const labels=[], actual=[], pred1=[], pred3=[], pred6=[];
        for(let i=0;i<len;i++){
            const r = rainData[i].value;
            const f = flowData[i].value;
            const l = levelData[i].value;
            const ts = levelData[i].timestamp;
            labels.push(new Date(ts).toLocaleTimeString());
            actual.push(l);
            pred1.push(l + (r*0.01) + (f*0.02));
            pred3.push(l + (r*0.02) + (f*0.03));
            pred6.push(l + (r*0.03) + (f*0.05));
        }

        window.predChart.data.labels = labels;
        window.predChart.data.datasets[0].data = actual;
        window.predChart.data.datasets[1].data = pred1;
        window.predChart.data.datasets[2].data = pred3;
        window.predChart.data.datasets[3].data = pred6;
        window.predChart.update();

        // Prefill last input values
        const lastR = rainData[len-1]?.value || 0;
        const lastF = flowData[len-1]?.value || 0;
        const lastL = levelData[len-1]?.value || 0;
        document.getElementById('rainfall').value = lastR;
        document.getElementById('flow').value = lastF;
        document.getElementById('water_level').value = lastL;
    });
}

// Predict button
document.getElementById('predictBtn').addEventListener('click', () => {
    const rain=parseFloat(document.getElementById('rainfall').value);
    const flow=parseFloat(document.getElementById('flow').value);
    const water=parseFloat(document.getElementById('water_level').value);
    if(isNaN(rain) || isNaN(flow) || isNaN(water)){
        document.getElementById('predictStatus').innerText = "Enter all values.";
        return;
    }
    const timestamp = Date.now();
    db.ref('rainfall_data').push({ value: rain, timestamp });
    db.ref('water_flow_data').push({ value: flow, timestamp });
    db.ref('water_level_data').push({ value: water, timestamp });
    document.getElementById('predictStatus').innerText = "Prediction saved!";
    loadLastRecords();
});

// Initial load
loadLastRecords();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
